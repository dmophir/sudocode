# .github/workflows/test-install.yml
# Document installation results across various environments
# Related to issue i-4o90: Reproduce and document node-pty build failures

name: Document Installation Results

on:
  workflow_dispatch: # Manual trigger for documentation purposes
  push:
    branches: [main, fix-setup-issue]

jobs:
  # Expected: PASS (has build tools)
  macos-working:
    name: "macOS (working Xcode)"
    runs-on: macos-latest
    steps:
      - uses: actions/setup-node@v4
        with:
          node-version: '22'
      - name: Show environment
        run: |
          echo "Node version: $(node --version)"
          echo "npm version: $(npm --version)"
          echo "Xcode path: $(xcode-select -p)"
          echo "SDK path: $(xcrun --show-sdk-path)"
      - name: Test install
        run: npm install -g sudocode && sudocode --version

  # Hypothesis 1: Bad SDKROOT environment variable
  macos-bad-sdkroot:
    name: "macOS (bad SDKROOT env var)"
    runs-on: macos-latest
    continue-on-error: true
    steps:
      - uses: actions/setup-node@v4
        with:
          node-version: '22'
      - name: Show environment
        run: |
          echo "Node: $(node --version)"
          echo "SDK path: $(xcrun --show-sdk-path)"
      - name: Test with bad SDKROOT
        run: |
          export SDKROOT=/nonexistent/sdk
          npm install -g sudocode 2>&1 || true

  # Hypothesis 2: Homebrew clang instead of Apple clang
  macos-homebrew-llvm:
    name: "macOS (Homebrew LLVM/clang)"
    runs-on: macos-latest
    continue-on-error: true
    steps:
      - uses: actions/setup-node@v4
        with:
          node-version: '22'
      - name: Install Homebrew LLVM
        run: brew install llvm
      - name: Test with Homebrew clang in PATH
        run: |
          export PATH="$(brew --prefix llvm)/bin:$PATH"
          echo "Using clang: $(which clang++)"
          clang++ --version
          npm install -g sudocode 2>&1 || true

  # Hypothesis 3: Switch to CommandLineTools only (remove Xcode)
  macos-clt-only:
    name: "macOS (CommandLineTools only, no Xcode)"
    runs-on: macos-latest
    continue-on-error: true
    steps:
      - uses: actions/setup-node@v4
        with:
          node-version: '22'
      - name: Switch to CommandLineTools
        run: |
          sudo xcode-select --switch /Library/Developer/CommandLineTools
          echo "Now using: $(xcode-select -p)"
          echo "SDK path: $(xcrun --show-sdk-path)"
      - name: Test install
        run: npm install -g sudocode 2>&1 || true

  # Hypothesis 4: macOS 15 specific - use macos-15 runner
  macos-15-sequoia:
    name: "macOS 15 Sequoia"
    runs-on: macos-15
    continue-on-error: true
    steps:
      - uses: actions/setup-node@v4
        with:
          node-version: '22'
      - name: Show environment
        run: |
          sw_vers
          echo "---"
          echo "Xcode path: $(xcode-select -p)"
          echo "SDK path: $(xcrun --show-sdk-path)"
          clang++ --version
      - name: Test install
        run: npm install -g sudocode && sudocode --version

  # Hypothesis 5: Use Volta like the user
  macos-volta:
    name: "macOS with Volta"
    runs-on: macos-latest
    continue-on-error: true
    steps:
      - name: Install Volta
        run: curl https://get.volta.sh | bash
      - name: Install Node via Volta
        run: |
          export VOLTA_HOME="$HOME/.volta"
          export PATH="$VOLTA_HOME/bin:$PATH"
          volta install node@22
          node --version
      - name: Test install
        run: |
          export VOLTA_HOME="$HOME/.volta"
          export PATH="$VOLTA_HOME/bin:$PATH"
          npm install -g sudocode 2>&1 || true

  # Expected: PASS (has build tools)
  docker-full:
    name: "Docker node:22 (full image)"
    runs-on: ubuntu-latest
    steps:
      - name: Test install
        run: docker run --rm node:22 sh -c "npm install -g sudocode && sudocode --version"

  # Expected: FAIL (missing Python/make/g++)
  docker-slim:
    name: "Docker node:22-slim"
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Test install (expected to fail)
        run: docker run --rm node:22-slim sh -c "npm install -g sudocode && sudocode --version" 2>&1 || true

  # Expected: FAIL (missing build tools)
  docker-alpine:
    name: "Docker node:22-alpine"
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Test install (expected to fail)
        run: docker run --rm node:22-alpine sh -c "npm install -g sudocode && sudocode --version" 2>&1 || true

  # Expected: PASS (has build tools)
  ubuntu:
    name: "Ubuntu (GitHub Actions runner)"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/setup-node@v4
        with:
          node-version: '22'
      - name: Show environment
        run: |
          echo "Node version: $(node --version)"
          echo "npm version: $(npm --version)"
          echo "Python version: $(python3 --version)"
          echo "g++ version: $(g++ --version | head -1)"
      - name: Test install
        run: npm install -g sudocode && sudocode --version

  # Expected: PASS (Windows has build tools via npm)
  windows:
    name: "Windows (GitHub Actions runner)"
    runs-on: windows-latest
    steps:
      - uses: actions/setup-node@v4
        with:
          node-version: '22'
      - name: Show environment
        run: |
          echo "Node version: $(node --version)"
          echo "npm version: $(npm --version)"
        shell: bash
      - name: Test install
        run: npm install -g sudocode && sudocode --version
        shell: bash
